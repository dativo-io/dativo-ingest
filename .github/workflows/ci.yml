name: CI - Complete Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # Job 1: Linting and Code Quality
  lint:
    name: Linting
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push formatting changes
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy
      
      - name: Auto-format code
        run: |
          make format
      
      - name: Check for formatting changes
        id: format-check
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "⚠️  Code formatting changes detected"
            git diff
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "✅ Code is properly formatted"
          fi
      
      - name: Commit and push formatting changes (push events only)
        if: github.event_name == 'push' && steps.format-check.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          git commit -m "Auto-format code [skip ci]" || exit 0
          git push origin HEAD:${{ github.ref }}
      
      - name: Fail if formatting needed (PRs only)
        if: github.event_name == 'pull_request' && steps.format-check.outputs.changes == 'true'
        run: |
          echo "❌ Code formatting issues found. Please run 'make format' locally and commit the changes."
          exit 1
      
      - name: Lint code (format check + flake8)
        run: |
          make lint
  
  # Job 2: Core Unit Tests
  core-tests:
    name: Core Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-mock pytest-cov
      
      - name: Run core unit tests
        env:
          PYTHONPATH: ${{ github.workspace }}/src
        run: |
          pytest tests/test_config.py tests/test_validator.py tests/test_state.py -v --cov=dativo_ingest --cov-report=xml
      
      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml
          flags: core-tests
          name: core-coverage-${{ matrix.python-version }}
  
  # Job 3: Plugin System Tests
  plugin-tests:
    name: Plugin System Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-mock pytest-cov
      
      - name: Run plugin tests
        env:
          PYTHONPATH: ${{ github.workspace }}/src
        run: |
          pytest tests/test_plugins.py -v --cov=dativo_ingest.plugins --cov=dativo_ingest.rust_plugin_bridge --cov-report=xml
      
      - name: Run plugin integration tests
        env:
          PYTHONPATH: ${{ github.workspace }}/src
        run: |
          chmod +x tests/test_plugin_integration.sh
          ./tests/test_plugin_integration.sh
  
  # Job 4: Rust Plugin Build
  rust-plugins:
    name: Build Rust Plugins
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      
      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            examples/plugins/rust/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('examples/plugins/rust/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Build and test Rust plugins
        run: |
          cd examples/plugins/rust
          cargo build --release
          cargo test --release
          chmod +x test_rust_plugins.sh
          ./test_rust_plugins.sh
  
  # Job 5: Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [core-tests, plugin-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-mock
      
      - name: Build Rust plugins
        run: |
          cd examples/plugins/rust
          cargo build --release
      
      - name: Run master test suite
        env:
          PYTHONPATH: ${{ github.workspace }}/src
        run: |
          chmod +x tests/run_all_plugin_tests.sh
          ./tests/run_all_plugin_tests.sh
  
  # Job 6: Build Status Check
  build-status:
    name: Build Status
    runs-on: ubuntu-latest
    needs: [lint, core-tests, plugin-tests, rust-plugins, integration-tests]
    if: always()
    
    steps:
      - name: Check build status
        run: |
          echo "=========================================="
          echo "Complete CI Test Suite Results"
          echo "=========================================="
          echo ""
          echo "Linting:            ${{ needs.lint.result }}"
          echo "Core Tests:         ${{ needs.core-tests.result }}"
          echo "Plugin Tests:       ${{ needs.plugin-tests.result }}"
          echo "Rust Plugins:       ${{ needs.rust-plugins.result }}"
          echo "Integration Tests:  ${{ needs.integration-tests.result }}"
          echo ""
          
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.core-tests.result }}" != "success" ] || \
             [ "${{ needs.plugin-tests.result }}" != "success" ] || \
             [ "${{ needs.rust-plugins.result }}" != "success" ] || \
             [ "${{ needs.integration-tests.result }}" != "success" ]; then
            echo "❌ Build failed - some checks did not pass"
            exit 1
          else
            echo "✅ All checks passed successfully!"
          fi
