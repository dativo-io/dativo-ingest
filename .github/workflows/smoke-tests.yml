name: Smoke Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: Adventureworks
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_USER: test
          MYSQL_PASSWORD: test
          MYSQL_DATABASE: employees
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
          --health-start-period=30s

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl
          
      - name: Start MinIO
        run: |
          # Start MinIO in background using Docker (GitHub Actions runners have Docker pre-installed)
          docker run -d \
            --name minio \
            -p 9000:9000 \
            -p 9001:9001 \
            -e MINIO_ROOT_USER=minioadmin \
            -e MINIO_ROOT_PASSWORD=minioadmin \
            minio/minio:latest server /data --console-address ":9001"
          
          # Wait for MinIO to be ready
          echo "Waiting for MinIO to be ready..."
          for i in {1..30}; do
            if curl -f http://localhost:9000/minio/health/live 2>/dev/null; then
              echo "âœ… MinIO is ready"
              break
            fi
            echo "Attempt $i/30: MinIO not ready yet, waiting..."
            sleep 2
          done

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          # psycopg2-binary and mysql-connector-python are now in pyproject.toml dependencies

      - name: Load AdventureWorks test data
        run: |
          # Install PostgreSQL client
          sudo apt-get install -y postgresql-client
          
          # Wait for Postgres to be ready
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for Postgres..."
            sleep 2
          done
          
          # Load minimal test data
          PGPASSWORD=postgres psql -h localhost -p 5432 -U postgres -d Adventureworks <<'EOF'
          CREATE SCHEMA IF NOT EXISTS person;
          CREATE SCHEMA IF NOT EXISTS production;
          CREATE SCHEMA IF NOT EXISTS sales;
          CREATE SCHEMA IF NOT EXISTS humanresources;
          
          CREATE TABLE IF NOT EXISTS person.person (
            businessentityid INTEGER PRIMARY KEY,
            persontype VARCHAR(2),
            namestyle BOOLEAN,
            firstname VARCHAR(50),
            lastname VARCHAR(50),
            emailpromotion INTEGER,
            modifieddate TIMESTAMP
          );
          
          INSERT INTO person.person (businessentityid, persontype, namestyle, firstname, lastname, emailpromotion, modifieddate) VALUES
          (1, 'EM', false, 'Ken', 'SÃ¡nchez', 0, '2009-01-07 00:00:00'),
          (2, 'SC', false, 'Terri', 'Duffy', 1, '2008-01-24 00:00:00'),
          (3, 'EM', false, 'Roberto', 'Tamburello', 0, '2007-11-04 00:00:00')
          ON CONFLICT (businessentityid) DO NOTHING;
          
          CREATE TABLE IF NOT EXISTS production.product (
            productid INTEGER PRIMARY KEY,
            name VARCHAR(50),
            productnumber VARCHAR(25),
            makeflag BOOLEAN,
            finishedgoodsflag BOOLEAN,
            color VARCHAR(15),
            safetystocklevel INTEGER,
            reorderpoint INTEGER,
            standardcost DECIMAL,
            listprice DECIMAL,
            size VARCHAR(5),
            weight DECIMAL,
            daystomanufacture INTEGER,
            productline VARCHAR(2),
            class VARCHAR(2),
            style VARCHAR(2),
            sellstartdate TIMESTAMP,
            sellenddate TIMESTAMP,
            modifieddate TIMESTAMP
          );
          
          INSERT INTO production.product (productid, name, productnumber, makeflag, finishedgoodsflag, color, safetystocklevel, reorderpoint, standardcost, listprice, size, weight, daystomanufacture, productline, class, style, sellstartdate, sellenddate, modifieddate) VALUES
          (1, 'Adjustable Race', 'AR-5381', false, false, NULL, 1000, 750, 0.00, 0.00, NULL, NULL, 0, NULL, NULL, NULL, '2008-04-30 00:00:00', NULL, '2008-04-30 00:00:00'),
          (2, 'Bearing Ball', 'BA-8327', false, false, NULL, 1000, 750, 0.00, 0.00, NULL, NULL, 0, NULL, NULL, NULL, '2008-04-30 00:00:00', NULL, '2008-04-30 00:00:00'),
          (3, 'BB Ball Bearing', 'BE-2349', false, false, NULL, 800, 600, 0.00, 0.00, NULL, NULL, 0, NULL, NULL, NULL, '2008-04-30 00:00:00', NULL, '2008-04-30 00:00:00')
          ON CONFLICT (productid) DO NOTHING;
          
          CREATE TABLE IF NOT EXISTS sales.customer (
            customerid INTEGER PRIMARY KEY,
            personid INTEGER,
            storeid INTEGER,
            territoryid INTEGER,
            accountnumber VARCHAR(10),
            modifieddate TIMESTAMP
          );
          
          INSERT INTO sales.customer (customerid, personid, storeid, territoryid, accountnumber, modifieddate) VALUES
          (1, 1, NULL, 1, 'AW00000001', '2009-01-07 00:00:00'),
          (2, 2, NULL, 1, 'AW00000002', '2008-01-24 00:00:00'),
          (3, 3, NULL, 1, 'AW00000003', '2007-11-04 00:00:00')
          ON CONFLICT (customerid) DO NOTHING;
          
          CREATE TABLE IF NOT EXISTS sales.sales_order_header (
            salesorderid INTEGER PRIMARY KEY,
            revisionnumber INTEGER,
            orderdate TIMESTAMP,
            duedate TIMESTAMP,
            shipdate TIMESTAMP,
            status INTEGER,
            onlineorderflag BOOLEAN,
            purchaseordernumber VARCHAR(25),
            accountnumber VARCHAR(15),
            customerid INTEGER,
            salespersonid INTEGER,
            territoryid INTEGER,
            billtoaddressid INTEGER,
            shiptoaddressid INTEGER,
            shipmethodid INTEGER,
            creditcardid INTEGER,
            creditcardapprovalcode VARCHAR(15),
            currencyrateid INTEGER,
            subtotal DECIMAL,
            taxamt DECIMAL,
            freight DECIMAL,
            totaldue DECIMAL,
            comment TEXT,
            rowguid UUID,
            modifieddate TIMESTAMP
          );
          
          INSERT INTO sales.sales_order_header (salesorderid, revisionnumber, orderdate, duedate, shipdate, status, onlineorderflag, purchaseordernumber, accountnumber, customerid, salespersonid, territoryid, billtoaddressid, shiptoaddressid, shipmethodid, creditcardid, creditcardapprovalcode, currencyrateid, subtotal, taxamt, freight, totaldue, comment, rowguid, modifieddate) VALUES
          (43659, 8, '2011-05-31 00:00:00', '2011-06-12 00:00:00', '2011-06-07 00:00:00', 5, false, 'PO5221457871', '10-4020-000676', 29825, 279, 4, 985, 985, 5, 16281, 'ViVi2131', NULL, 1294.2529, 124.2483, 38.8276, 1457.3288, NULL, '89E42A0A-5F0B-4A9B-8C6D-123456789012', '2011-06-07 00:00:00'),
          (43660, 8, '2011-05-31 00:00:00', '2011-06-12 00:00:00', '2011-06-07 00:00:00', 5, false, 'PO18850127500', '10-4020-000117', 29672, 279, 4, 921, 921, 5, 5618, 'OK20722', NULL, 2674.3500, 256.7376, 80.2305, 3011.3181, NULL, 'A5F3A0F3-9C9B-4A9B-8C6D-123456789013', '2011-06-07 00:00:00'),
          (43661, 8, '2011-05-31 00:00:00', '2011-06-12 00:00:00', '2011-06-07 00:00:00', 5, false, 'PO18473189620', '10-4020-000442', 29734, 279, 4, 915, 915, 5, 1346, 'Vi82879', NULL, 2674.3500, 256.7376, 80.2305, 3011.3181, NULL, 'B6F4B1F4-AD0C-5B0C-9D7E-123456789014', '2011-06-07 00:00:00')
          ON CONFLICT (salesorderid) DO NOTHING;
          
          CREATE TABLE IF NOT EXISTS humanresources.employee (
            businessentityid INTEGER PRIMARY KEY,
            nationalidnumber VARCHAR(15),
            loginid VARCHAR(256),
            jobtitle VARCHAR(50),
            birthdate DATE,
            maritialstatus VARCHAR(1),
            gender VARCHAR(1),
            hiredate DATE,
            salariedflag BOOLEAN,
            vacationhours INTEGER,
            sickleavehours INTEGER,
            currentflag BOOLEAN,
            rowguid UUID,
            modifieddate TIMESTAMP
          );
          
          INSERT INTO humanresources.employee (businessentityid, nationalidnumber, loginid, jobtitle, birthdate, maritialstatus, gender, hiredate, salariedflag, vacationhours, sickleavehours, currentflag, rowguid, modifieddate) VALUES
          (1, '295847284', 'adventure-works\ken0', 'Chief Executive Officer', '1969-01-29', 'S', 'M', '2009-01-14', true, 99, 69, true, 'F01251E5-96A3-4D75-8B4D-123456789015', '2014-06-30 00:00:00'),
          (2, '245797967', 'adventure-works\terri0', 'Vice President of Engineering', '1971-08-01', 'S', 'F', '2008-01-31', true, 1, 20, true, '45E8F437-937D-4B3F-8C5E-123456789016', '2014-06-30 00:00:00')
          ON CONFLICT (businessentityid) DO NOTHING;
          
          CREATE TABLE IF NOT EXISTS person.address (
            addressid INTEGER PRIMARY KEY,
            addressline1 VARCHAR(60),
            city VARCHAR(30),
            stateprovinceid INTEGER,
            postalcode VARCHAR(15),
            modifieddate TIMESTAMP
          );
          
          INSERT INTO person.address (addressid, addressline1, city, stateprovinceid, postalcode, modifieddate) VALUES
          (1, '1970 Napa Ct.', 'Bothell', 79, '98011', '2007-12-19 00:00:00'),
          (2, '9833 Mt. Dias Blv.', 'Bothell', 79, '98011', '2007-12-19 00:00:00'),
          (3, '7484 Roundtree Drive', 'Bothell', 79, '98011', '2007-12-19 00:00:00')
          ON CONFLICT (addressid) DO NOTHING;
          
          CREATE TABLE IF NOT EXISTS production.productcategory (
            productcategoryid INTEGER PRIMARY KEY,
            name VARCHAR(50),
            modifieddate TIMESTAMP
          );
          
          INSERT INTO production.productcategory (productcategoryid, name, modifieddate) VALUES
          (1, 'Bikes', '2007-12-19 00:00:00'),
          (2, 'Components', '2007-12-19 00:00:00'),
          (3, 'Clothing', '2007-12-19 00:00:00')
          ON CONFLICT (productcategoryid) DO NOTHING;
          EOF
          
          echo "âœ… AdventureWorks test data loaded"

      - name: Load MySQL test data
        timeout-minutes: 5
        run: |
          # Install MySQL client and netcat for port checking
          sudo apt-get install -y mysql-client netcat-openbsd
          
          # Wait for MySQL to be ready (with timeout and better diagnostics)
          echo "Waiting for MySQL to be ready..."
          MAX_WAIT=120  # Maximum wait time in seconds (increased for slow startup)
          WAIT_COUNT=0
          
          # First, wait for MySQL port to be accessible
          echo "Checking if MySQL port 3306 is accessible..."
          while ! nc -z localhost 3306 2>/dev/null; do
            if [ $WAIT_COUNT -ge $MAX_WAIT ]; then
              echo "âŒ MySQL port 3306 did not become accessible within $MAX_WAIT seconds"
              echo "Checking MySQL service status..."
              docker ps -a | grep mysql || echo "No MySQL container found"
              exit 1
            fi
            echo "Waiting for MySQL port... ($WAIT_COUNT/$MAX_WAIT seconds)"
            sleep 2
            WAIT_COUNT=$((WAIT_COUNT + 2))
          done
          echo "âœ… MySQL port 3306 is accessible"
          
          # Then wait for MySQL to accept connections (use TCP, not Unix socket)
          echo "Waiting for MySQL to accept connections..."
          WAIT_COUNT=0
          while ! mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot --silent 2>/dev/null; do
            if [ $WAIT_COUNT -ge $MAX_WAIT ]; then
              echo "âŒ MySQL did not become ready within $MAX_WAIT seconds"
              echo "Attempting diagnostic connection..."
              mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot 2>&1 || true
              echo "Checking MySQL error log..."
              docker logs $(docker ps -q --filter "ancestor=mysql:8.0") 2>&1 | tail -20 || echo "Could not retrieve logs"
              exit 1
            fi
            echo "Waiting for MySQL connection... ($WAIT_COUNT/$MAX_WAIT seconds)"
            sleep 2
            WAIT_COUNT=$((WAIT_COUNT + 2))
          done
          echo "âœ… MySQL is ready and accepting connections"
          
          # Create minimal test schema and data (instead of loading full employees database)
          # This is much faster and sufficient for smoke tests
          # Use 127.0.0.1 instead of localhost to force TCP connection (not Unix socket)
          mysql -h 127.0.0.1 -P 3306 -u root -proot <<'EOF'
          CREATE DATABASE IF NOT EXISTS employees;
          USE employees;
          
          -- Create departments table
          CREATE TABLE IF NOT EXISTS departments (
            dept_no CHAR(4) NOT NULL,
            dept_name VARCHAR(40) NOT NULL,
            PRIMARY KEY (dept_no),
            UNIQUE KEY dept_name (dept_name)
          ) ENGINE=InnoDB;
          
          -- Create employees table
          CREATE TABLE IF NOT EXISTS employees (
            emp_no INT NOT NULL,
            birth_date DATE NOT NULL,
            first_name VARCHAR(14) NOT NULL,
            last_name VARCHAR(16) NOT NULL,
            gender ENUM('M','F') NOT NULL,
            hire_date DATE NOT NULL,
            PRIMARY KEY (emp_no)
          ) ENGINE=InnoDB;
          
          -- Insert minimal test data
          INSERT IGNORE INTO departments (dept_no, dept_name) VALUES
          ('d001', 'Marketing'),
          ('d002', 'Finance'),
          ('d003', 'Human Resources');
          
          INSERT IGNORE INTO employees (emp_no, birth_date, first_name, last_name, gender, hire_date) VALUES
          (10001, '1953-09-02', 'Georgi', 'Facello', 'M', '1986-06-26'),
          (10002, '1964-06-02', 'Bezalel', 'Simmel', 'F', '1985-11-21'),
          (10003, '1959-12-03', 'Parto', 'Bamford', 'M', '1986-08-28');
          
          -- Grant permissions to test user
          GRANT ALL PRIVILEGES ON employees.* TO 'test'@'%';
          FLUSH PRIVILEGES;
          EOF
          
          # Verify MySQL data loaded
          mysql -h 127.0.0.1 -P 3306 -u test -ptest -e "USE employees; SELECT COUNT(*) as dept_count FROM departments;" || echo "âš ï¸  Could not verify MySQL data"
          
          echo "âœ… MySQL test data loaded (minimal dataset)"

      - name: Set up MinIO bucket
        run: |
          # Install MinIO client
          wget -q https://dl.min.io/client/mc/release/linux-amd64/mc
          chmod +x mc
          sudo mv mc /usr/local/bin/
          
          # Configure MinIO client and create bucket
          mc alias set local http://localhost:9000 minioadmin minioadmin
          mc mb local/test-bucket || true  # Ignore if bucket already exists
          echo "âœ… MinIO bucket 'test-bucket' created"

      - name: Set up environment variables
        run: |
          mkdir -p .github/workflows
          cat > .github/workflows/test.env << EOF
          # S3/MinIO configuration
          S3_ENDPOINT=http://localhost:9000
          AWS_ACCESS_KEY_ID=minioadmin
          AWS_SECRET_ACCESS_KEY=minioadmin
          AWS_REGION=us-east-1
          
          # Nessie (optional - not needed for smoke test)
          # NESSIE_URI=http://localhost:19120/api/v1
          EOF
          cat .github/workflows/test.env

      - name: Create state directory
        run: |
          # Use temp directory for CI/CD to avoid polluting repo
          mkdir -p /tmp/dativo-state/test_tenant

      - name: Build Rust plugins (if needed)
        run: |
          # Install Rust if not already available
          if ! command -v cargo &> /dev/null; then
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            source $HOME/.cargo/env
          fi
          
          # Build Rust plugins if the script exists
          if [ -f tests/build_rust_plugins.sh ]; then
            chmod +x tests/build_rust_plugins.sh
            bash tests/build_rust_plugins.sh || echo "âš ï¸  Rust plugin build failed (non-critical)"
          fi

      - name: Run smoke tests
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGDATABASE: Adventureworks
          PGUSER: postgres
          PGPASSWORD: postgres
          MYSQL_HOST: localhost
          MYSQL_PORT: 3306
          MYSQL_DATABASE: employees
          MYSQL_USER: test
          MYSQL_PASSWORD: test
          MINIO_ENDPOINT: http://localhost:9000
          MINIO_ACCESS_KEY: minioadmin
          MINIO_SECRET_KEY: minioadmin
          S3_ENDPOINT: http://localhost:9000
          AWS_ACCESS_KEY_ID: minioadmin
          AWS_SECRET_ACCESS_KEY: minioadmin
          AWS_REGION: us-east-1
          STATE_DIR: /tmp/dativo-state
          PYTHONPATH: src
        run: |
          # Clear any existing state to ensure fresh test run
          rm -rf /tmp/dativo-state/test_tenant
          
          # Make scripts executable
          chmod +x tests/run_all_smoke_tests.sh
          chmod +x tests/smoke_tests.sh
          chmod +x tests/smoke_tests_custom_plugins.sh
          
          # Run smoke tests using the consolidated script
          # --skip-infrastructure-setup: Services are set up by workflow steps
          # --skip-env-setup: Environment variables are set in workflow
          # --skip-rust-build: Rust plugins built in previous step
          bash tests/run_all_smoke_tests.sh --skip-infrastructure-setup --skip-env-setup --skip-rust-build

      - name: Verify files in MinIO
        run: |
          mc ls local/test-bucket --recursive || echo "âš ï¸  Could not list files (non-critical)"

      - name: Upload test artifacts (if test fails)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            /tmp/dativo-state/
            *.log
          retention-days: 1
          if-no-files-found: ignore
      
      - name: Cleanup test artifacts
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up test artifacts..."
          
          # Clean up state files
          echo "  - Removing state directory..."
          rm -rf /tmp/dativo-state
          
          # Clean up temporary Parquet files (written to system temp during processing)
          echo "  - Removing temporary Parquet files..."
          rm -rf /tmp/dativo_ingest* 2>/dev/null || true
          rm -rf /tmp/*.parquet 2>/dev/null || true
          
          # Clean up any log files
          echo "  - Removing log files..."
          rm -f *.log 2>/dev/null || true
          rm -f **/*.log 2>/dev/null || true
          
          # Clean up any other temporary files in project root
          echo "  - Removing other temporary files..."
          find . -maxdepth 1 -name "*.tmp" -type f -delete 2>/dev/null || true
          find . -maxdepth 1 -name "*.temp" -type f -delete 2>/dev/null || true
          
          # Clean up test environment file
          echo "  - Removing test environment file..."
          rm -f .github/workflows/test.env 2>/dev/null || true
          
          # Note: MinIO test bucket data is kept for verification
          # To clean MinIO bucket, uncomment:
          # mc rm --recursive --force local/test-bucket/ || true
          
          echo "âœ… Cleanup complete"

